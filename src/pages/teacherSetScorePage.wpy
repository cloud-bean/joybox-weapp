<style lang="less">
.score{
  width: 60%;
  margin: 0 auto;
  margin-top: 20rpx;
}
.message{
  margin-top: 20rpx;
  padding: 20rpx;
  textarea{
    margin: 0 auto;
    border: 1rpx solid #ccc;
    padding: 10rpx;
    width: 95%;
  }
  input{
    border: 1rpx solid #ccc;
    padding: 10rpx;
    width: 95%;
    margin: 5rpx auto;
  }
  button{
    margin-top: 20rpx;

  }
  .title{
    margin: 0 auto;
  }
}
.entity{
  margin-top: 20rpx;
  text-align: center;
  image{
    margin: 0 auto;
  }
}
.wrapper{
}
.hidden-input{
  display:none;
}
</style>

<template>
  <view class="wrapper">
    <form bindsubmit="formSubmit" bindreset="formReset" report-submit="true">
    <view class="score">
      <!-- <starPanel></starPanel> -->
      <view hidden="true">
        <input name="orderId" value="{{activeOrder._id}}"/>
      </view>
    </view>
    <view class="message">
      <text class="title">{{activeOrder.task.name}}-{{activeOrder.student.displayName}}</text>
      <input type="number" name="score" value="" placeholder="请输入评分" auto-focus></input>
      <textarea name="comments" placeholder="请输入作业评语" ></textarea>
      <button size="small" type="primary" formType="submit">提交评价</button>
    </view>
  </form>
    <view class="entity">
      <view wx:if="{{activeOrder.files[0].type === 0 }}">
        <image src="{{fileURL}}" mode="widthFix"></image>
      </view>
      <view wx:if="{{activeOrder.files[0].type === 1 }}">
        <audio src="{{fileURL}}" controls></audio>
      </view>
      <view wx:if="{{activeOrder.files[0].type === 2 }}">
        <video src="{{fileURL}}" class="video-preview" controls></video>
      </view>
      <!-- <image mode= "aspectFit" src="./head.jpg"></image> -->
    </view>
  </view>
</template>

<script>
import wepy from 'wepy'
// import starPanel from '../components/teacherSetScorePage/starPanel'
import { connect } from 'wepy-redux'
import * as api from '../api'

@connect({
  activeOrder (state) {
    return state.order.activeOrder
  }
},{

})
export default class TeacherSetScorePage extends wepy.page {
  data = {
    fileURL:''
  }
  components = {
    // starPanel
  }
  methods = {
    async formSubmit (e) {
      console.log(`form发生了submit事件, formId: ${e.detail.formId}，携带数据为：${JSON.stringify(e.detail.value)}`)
      const {score, comments, orderId} = e.detail.value;
      const res = await api.setScore(score, comments, orderId) // dispatch submit order action
      console.log(res);
      wx.navigateTo({
        url: '/pages/teacherOrderListPage'
      })
    },
  }
  async onLoad(){
    const that = this
    console.log(that.activeOrder.files[0].URL);
    try{
      wepy.showLoading({
        title:'素材下载中',
        mask: true
      })
      const {tempFilePath} = await wepy.downloadFile({url: that.activeOrder.files[0].URL})
      this.fileURL = tempFilePath
      wepy.hideLoading()
    } catch (e) {
      console.log(e)
    }
  //   let downloadTask = wx.downloadFile({
  //     url: that.activeOrder.files[0].URL,
  //     success: function (res) {
  //       that.fileURL = res.tempFilePath
  //       console.log(that.fileURL);
  //     },
  //     fail: function (res){
  //       console.log(res);
  //     },
  //     complete(){
  //       console.log('complete');
  //     }
  //   })
  //   downloadTask.onProgressUpdate((res) => {
  //   console.log('下载进度', res.progress)
  //   console.log('已经下载的数据长度', res.totalBytesWritten)
  //   console.log('预期需要下载的数据总长度', res.totalBytesExpectedToWrite)
  // })


  }
}
</script>
